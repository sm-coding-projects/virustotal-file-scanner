# Dockerfile for PostgreSQL database
FROM postgres:14-alpine

# Add initialization scripts
COPY docker/init-db.sql /docker-entrypoint-initdb.d/

# Set recommended PostgreSQL configurations for better performance
RUN echo "max_connections = 100" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "shared_buffers = 128MB" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "effective_cache_size = 512MB" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "work_mem = 4MB" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "maintenance_work_mem = 64MB" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "random_page_cost = 1.1" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "temp_file_limit = 5GB" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "log_min_duration_statement = 200" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "autovacuum = on" >> /usr/local/share/postgresql/postgresql.conf.sample && \
    echo "listen_addresses = '*'" >> /usr/local/share/postgresql/postgresql.conf.sample

# Add health check
HEALTHCHECK --interval=10s --timeout=5s --start-period=10s --retries=5 \
  CMD pg_isready -U postgres || exit 1

# Expose PostgreSQL port
EXPOSE 5432